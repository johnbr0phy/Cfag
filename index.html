<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketching Year 2025-26 - Interactive Course Book</title>
    <style>
        :root {
            --primary-color: #0056b3; /* Darker blue */
            --secondary-color: #e9ecef; /* Light grey */
            --accent-color: #ffc107; /* Amber/yellow */
            --text-color: #212529; /* Near black */
            --light-text: #495057; /* Grey */
            --border-color: #dee2e6; /* Lighter grey */
            --completed-color: #d1e7dd; /* Lighter success green */
            --completed-text: #0f5132; /* Darker success green */
            --hover-bg: #f8f9fa; /* Very light grey */
            --sidebar-width: 280px;
            --gallery-placeholder-bg: #f0f0f0;
        }

        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f8f9fa;
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden; /* Prevent body scrolling on desktop */
            font-size: 16px; /* Base font size */
        }

        .course-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            flex-shrink: 0;
            background-color: #ffffff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }
        .sidebar-header { padding: 18px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--primary-color); color: white; text-align: center; flex-shrink: 0; }
        .sidebar-header h2 { margin: 0; font-size: 1.2em; font-weight: 500; }
        #progress-indicator { padding: 12px 15px; font-size: 0.85em; background-color: var(--secondary-color); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #progress-text { margin-bottom: 8px; display: block; color: var(--light-text); }
        #progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 5px; overflow: hidden; height: 12px; margin-top: 5px; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); transition: width 0.4s ease-in-out; border-radius: 5px; }
        #week-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
        #week-list li { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s, border-left-color 0.2s; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; color: var(--light-text); position: relative; border-left: 4px solid transparent; }
        #week-list li:hover { background-color: var(--hover-bg); }
        #week-list li.active { background-color: var(--secondary-color); font-weight: 600; border-left-color: var(--primary-color); color: var(--text-color); }
        #week-list li.welcome-item.active { border-left-color: var(--accent-color); } /* Different highlight for welcome */
        #week-list li.completed { color: var(--completed-text); }
        #week-list li .week-status { font-size: 1.1em; margin-left: 10px; color: transparent; font-weight: bold; flex-shrink: 0; }
        #week-list li.completed .week-status { color: var(--completed-text); }
        #week-list li .week-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 5px; }
        #week-list li.welcome-item .week-status { display: none; } /* Hide checkmark for welcome */

        /* --- Main Content Area --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .main-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; position: relative; z-index: 10; }
        .main-header .navigation { display: flex; gap: 10px; }
        .navigation button, .header-actions button { padding: 8px 18px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; font-size: 0.9em; white-space: nowrap; }
        .navigation button:hover:not(:disabled), .header-actions button:hover:not(:disabled) { background-color: #004085; }
        .navigation button:disabled, .header-actions button:disabled { background-color: #adb5bd; cursor: not-allowed; opacity: 0.7; }
        #current-week-display { font-size: 1.05em; font-weight: 500; color: var(--text-color); text-align: center; flex-grow: 1; margin: 0 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions button { font-size: 0.85em; padding: 6px 12px; background-color: var(--secondary-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .header-actions button:hover:not(:disabled) { background-color: #d3d9df; }
        .content-scroll-area { flex-grow: 1; overflow-y: auto; padding: 25px 30px; background-color: #fdfdfd; -webkit-overflow-scrolling: touch; }

        /* --- Welcome Screen Content --- */
        .welcome-content { padding: 20px; }
        .welcome-content h1 { color: var(--primary-color); margin-top: 0; }
        .welcome-content p { line-height: 1.7; color: var(--light-text); margin-bottom: 1.5em; }
        .welcome-content strong { color: var(--text-color); }

        /* --- Detail View Content --- */
        #week-detail h2 { margin-top: 0; color: var(--primary-color); font-size: 1.7em; margin-bottom: 8px; font-weight: 600; line-height: 1.3; }
        #week-detail .week-meta { font-size: 0.9em; color: var(--light-text); margin-bottom: 25px; }
        #week-detail h3 { font-size: 1.3em; color: var(--text-color); margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 8px; font-weight: 500; }
        #week-detail p, #week-detail li { line-height: 1.7; color: var(--light-text); margin-bottom: 1em; }
        #week-detail strong { color: var(--text-color); font-weight: 600; }
        .encouragement-container, .trythis-container { background-color: #ffffff; padding: 15px 20px; border-radius: 5px; border: 1px solid var(--border-color); margin-top: 10px; }
        .encouragement-container p:last-child, .trythis-container p:last-child { margin-bottom: 0; }
        #week-detail img { max-width: 100%; height: auto; margin-top: 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: block; background-color: var(--secondary-color); border: 1px solid var(--border-color); }
        .image-placeholder { min-height: 150px; background-color: var(--secondary-color); border: 1px dashed var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--light-text); font-style: italic; border-radius: 5px; margin-top: 20px; text-align: center; padding: 20px; font-size: 0.9em; }
        .image-loaded-container img { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: none; }
        .image-placeholder.error { border-color: #dc3545; color: #dc3545; }

        /* --- Submission Area --- */
        .submission-area { margin-top: 30px; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; background-color: #fff; }
        .submission-area h4 { margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: var(--text-color); }
        #submission-upload { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        .upload-label { display: inline-block; padding: 8px 20px; font-size: 0.9em; font-weight: 500; color: white; background-color: var(--primary-color); border-radius: 4px; cursor: pointer; transition: background-color 0.2s; margin-right: 15px; -webkit-tap-highlight-color: transparent; }
        .upload-label:hover { background-color: #004085; }
        #file-info { display: inline-block; font-size: 0.9em; color: var(--light-text); font-style: italic; }
        #thumbnail-preview { display: block; max-width: 150px; max-height: 150px; margin-top: 15px; border-radius: 4px; border: 1px solid var(--border-color); object-fit: cover; }
        #thumbnail-preview:not([src]) { display: none; }

        /* --- Completion Toggle --- */
        .completion-toggle { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; }
        #complete-button { padding: 10px 25px; font-size: 1em; border-radius: 5px; cursor: pointer; border: 1px solid; transition: background-color 0.2s, color 0.2s, opacity 0.2s; -webkit-tap-highlight-color: transparent; }
        #complete-button:disabled { background-color: #adb5bd; border-color: #adb5bd; color: #fff; cursor: not-allowed; opacity: 0.65; }
        #complete-button.mark-complete { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
        #complete-button.mark-complete:hover:not(:disabled) { background-color: #004085; }
        #complete-button.mark-incomplete { background-color: var(--completed-color); border-color: var(--completed-text); color: var(--completed-text); font-weight: 500; }
        #complete-button.mark-incomplete:hover { background-color: #bcdfca; }

        /* --- Submissions Gallery View --- */
        #gallery-view { padding: 20px; }
        #gallery-view h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-top: 20px;
        }
        .gallery-item {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background-color: #fff;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .gallery-item img {
            max-width: 100%;
            height: 100px; /* Fixed height for consistency */
            object-fit: cover;
            display: block;
            margin: 0 auto 10px auto;
            border-radius: 3px;
        }
        .gallery-item .filename {
            font-size: 0.8em;
            color: var(--light-text);
            word-wrap: break-word; /* Wrap long filenames */
        }
        .gallery-item.user-submission {
            border-color: var(--primary-color); /* Highlight user's submission */
            border-width: 2px;
            background-color: #e7f1ff;
        }
         .gallery-item.placeholder {
            background-color: var(--gallery-placeholder-bg);
            border-style: dashed;
            display: flex;
            align-items: center;
            justify-content: center;
             height: 122px; /* Match image height + padding approx */
             color: var(--light-text);
             font-size: 0.9em;
         }
         #gallery-view .no-submissions {
             text-align: center;
             margin-top: 30px;
             color: var(--light-text);
             font-style: italic;
         }


        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; font-size: 15px; }
            .course-container { flex-direction: column; height: auto; }
            .sidebar { width: 100%; height: auto; max-height: 45vh; border-right: none; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
            .main-content { height: auto; overflow: visible; width: 100%; }
            .main-header { padding: 10px 15px; flex-wrap: wrap; justify-content: space-between; gap: 8px; }
            #current-week-display { order: 0; width: auto; flex-grow: 0; text-align: left; margin: 0; font-size: 1.1em; } /* Allow title next to actions */
            .main-header .navigation { order: 1; width: 100%; display: flex; justify-content: space-between; margin-top: 8px; } /* Nav buttons below title/actions */
            .header-actions { order: 0; } /* Actions next to title */
            .navigation button, .header-actions button { padding: 8px 12px; flex-grow: 1; flex-basis: 0; margin: 0 4px; font-size: 0.9em; }
            .header-actions button { flex-grow: 0; flex-basis: auto; } /* Don't stretch action buttons */
            .content-scroll-area { padding: 15px 15px 25px 15px; overflow-y: visible; }
            #week-detail h2 { font-size: 1.5em; }
            #week-detail h3 { font-size: 1.2em; }
            .submission-area { padding: 15px; }
            .upload-label { display: block; margin-bottom: 10px; text-align: center; }
            #file-info { display: block; text-align: center; }
            #thumbnail-preview { margin-left: auto; margin-right: auto; }
            #complete-button { font-size: 0.95em; padding: 10px 20px; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
            .gallery-item { padding: 8px; }
            .gallery-item img { height: 80px; }
            .gallery-item.placeholder { height: 100px; font-size: 0.8em;}
        }
        @media (max-width: 480px) {
            body { font-size: 14px; }
            .sidebar-header h2 { font-size: 1.1em; }
            #week-list li { font-size: 0.85em; padding: 10px 12px; }
            .main-header { padding: 8px 10px; gap: 5px; }
            #current-week-display { font-size: 1em; }
            .navigation button, .header-actions button { padding: 6px 10px; font-size: 0.85em;}
            .content-scroll-area { padding: 10px 10px 20px 10px; }
            #week-detail h2 { font-size: 1.4em; }
            #week-detail h3 { font-size: 1.15em; }
            .submission-area h4 { font-size: 1em; }
            .upload-label { font-size: 0.85em; padding: 8px 15px; }
            #file-info { font-size: 0.85em; }
            #complete-button { font-size: 0.9em; padding: 8px 15px; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;}
            .gallery-item img { height: 70px; }
            .gallery-item.placeholder { height: 88px; }
        }

    </style>
</head>
<body>
    <div class="course-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Sketching Year 25-26</h2>
            </div>
            <div id="progress-indicator">
                <span id="progress-text">Your Progress: 0 / 52</span>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
            </div>
            <ul id="week-list">
                <!-- Populated by JS -->
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="main-header">
                 <div class="navigation">
                    <button id="prev-button" disabled>< Previous</button>
                    <button id="next-button">Next ></button>
                 </div>
                <div id="current-week-display">Welcome</div> <!-- Dynamic Title -->
                 <div class="header-actions">
                    <button id="view-gallery-button" style="display: none;">View Gallery</button>
                    <button id="back-to-detail-button" style="display: none;">Back to Detail</button>
                 </div>
            </div>
            <div class="content-scroll-area" id="content-area">
                 <!-- Content (Welcome, Detail, or Gallery) is rendered here by JS -->
                 <div class="initial-loading" style="text-align: center; margin-top: 30px; color: var(--light-text);">Loading...</div>
            </div>
        </main>
    </div>

    <script>
        // --- Data --- (Embed your data here - Same as previous version)
        const sketchingData = [
            // ... (Keep your 52 weeks of data here) ...
             { Month: "M01 - Apr", Date: "Fri 28 Mar 25", WeekNum: "01", MonthlyTheme: "Spring Awakening", WeeklyPrompt: "Early Signs of Spring", EncouragementMessage: "### Spring Awakening ###\nSpring is here! A new season of sketching begins, full of fresh colours, blooming flowers, and the return of life to the landscape.\n\nNature is waking upâ€”so should your sketchbook! Look for the small but powerful signs of spring: the first blossoms, greener landscapes, or even the changing mood of the sky. Notice how the light softens as the days grow longer, casting warmer tones and creating fresh contrasts in the environment.\n\nThis weekâ€™s challenge: Go for a walkâ€”whether in a park, a garden, or even a city streetâ€”and observe the early signs of spring. Sketch what catches your eye, whether itâ€™s a delicate flower pushing through the ground, raindrops clinging to new leaves, or birds returning to nest.\n\nPost your sketches in the Facebook groupâ€”letâ€™s celebrate the season together!\n\nHappy sketching!", TryThis: "Try This: Use watercolours or coloured pencils to layer soft, fresh tones. \nCapture delicate textures with light, feathery strokes. Experiment with sketching outdoors, even if only for a few minutes, to observe real-time seasonal changes.", ImageURL: "https://photos.app.goo.gl/MUhcG7fwLY1m3z546" },
            // Add all other 51 weeks here...
             { Month: "M12 - Mar", Date: "Fri 20 Mar 26", WeekNum: "52", MonthlyTheme: "Interiors & Home Spaces", WeeklyPrompt: "Favourite Room or Object", EncouragementMessage: "A home is filled with objects that hold personal meaningâ€”a well-worn armchair, a treasured ornament, or a workspace where creativity happens. Sketching these familiar things can help develop storytelling in your art.\n\nThis weekâ€™s challenge: Choose your favourite room or object in your home and sketch it. Consider why itâ€™s meaningfulâ€”what details make it special? Try to capture the essence of the space, whether itâ€™s a cosy bedroom, a lively kitchen, or a well-used desk.\n\nWhat does this space say about you?\n\nPost your home sketches in the Facebook group!", TryThis: "Try This: Use soft shading or subtle colour to create mood. \nExperiment with perspectiveâ€”try a close-up of details or a wide-angle sketch of the whole room.", ImageURL: null }
        ];

        // --- Application State & Logic ---
        let currentView = 'welcome'; // 'welcome', 'detail', 'gallery'
        let currentWeekIndex = -1; // -1 for Welcome, 0 to 51 for actual weeks
        let selectedGalleryWeekNum = null; // Which week's gallery is showing
        let completionStatus = {}; // { '01': true, ... }
        let submissionStatus = {}; // { '01': { filename: '...', thumbnail: 'data:...' }, ... }
        const totalWeeks = sketchingData.length;
        const COMPLETION_STORAGE_KEY = 'sketchingCourseCompletion_25_26_v2'; // Updated key
        const SUBMISSION_STORAGE_KEY = 'sketchingCourseSubmissions_25_26_v2'; // Updated key
        const WELCOME_SEEN_KEY = 'sketchingCourseWelcomeSeen_25_26_v2'; // To track if welcome was seen *this session*
        const THUMBNAIL_MAX_WIDTH = 150;

        // DOM Elements
        const contentArea = document.getElementById('content-area');
        const weekList = document.getElementById('week-list');
        const currentWeekDisplay = document.getElementById('current-week-display');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const viewGalleryButton = document.getElementById('view-gallery-button');
        const backToDetailButton = document.getElementById('back-to-detail-button');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        // --- Utility Functions ---
        function loadState() { /* ... (Same as previous, using new keys) ... */
             // Load Completion Status
            const savedCompletion = localStorage.getItem(COMPLETION_STORAGE_KEY);
            try {
                completionStatus = savedCompletion ? JSON.parse(savedCompletion) : {};
                if (typeof completionStatus !== 'object' || completionStatus === null) completionStatus = {};
            } catch (e) { console.error("Error parsing completion status:", e); completionStatus = {}; }
            // Load Submission Status
            const savedSubmissions = localStorage.getItem(SUBMISSION_STORAGE_KEY);
             try {
                submissionStatus = savedSubmissions ? JSON.parse(savedSubmissions) : {};
                 if (typeof submissionStatus !== 'object' || submissionStatus === null) submissionStatus = {};
             } catch (e) { console.error("Error parsing submission status:", e); submissionStatus = {}; }
            // Initialize missing weeks
            sketchingData.forEach(week => {
                if (typeof completionStatus[week.WeekNum] !== 'boolean') completionStatus[week.WeekNum] = false;
                if (submissionStatus[week.WeekNum] === undefined) submissionStatus[week.WeekNum] = null;
             });
        }
        function saveData(key, data) { /* ... (Same as previous) ... */
             try { localStorage.setItem(key, JSON.stringify(data)); }
             catch (e) {
                 console.error(`Error saving data for key "${key}":`, e);
                 if (e.name === 'QuotaExceededError') {
                     alert('Could not save progress/submission. Browser local storage might be full.');
                 }
             }
        }
        function formatTextContent(text) { /* ... (Same as previous) ... */
             if (!text) return '';
            text = text.replace(/^### (.*?) ###$/gm, '<h3>$1</h3>');
            text = text.replace(/^(Try This:)/gim, '<strong>$1</strong>');
            let paragraphs = text.split(/\n\n+/);
            text = paragraphs.map(p => p.trim()).filter(p => p.length > 0)
                           .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
            return text;
        }
         function generateThumbnail(file, callback) { /* ... (Same as previous) ... */
            if (!file || !file.type.startsWith('image/')) { callback(null); return; }
             const reader = new FileReader();
             reader.onload = (e) => {
                 const img = new Image();
                 img.onload = () => {
                     const canvas = document.createElement('canvas');
                     const ctx = canvas.getContext('2d');
                     let width = img.width, height = img.height;
                     if (width > THUMBNAIL_MAX_WIDTH) { height *= THUMBNAIL_MAX_WIDTH / width; width = THUMBNAIL_MAX_WIDTH; }
                     canvas.width = width; canvas.height = height;
                     ctx.drawImage(img, 0, 0, width, height);
                     const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                     callback(dataUrl);
                 };
                 img.onerror = () => { console.error("Err loading img for thumb"); callback(null); };
                 img.src = e.target.result;
             };
             reader.onerror = () => { console.error("Err reading file for thumb"); callback(null); };
             reader.readAsDataURL(file);
         }

        // --- Core Rendering & State Updates ---

        function updateUI() {
            renderSidebarList();
            renderContentArea();
            updateHeader();
            updateProgress();
        }

        function renderSidebarList() {
            weekList.innerHTML = ''; // Clear

            // Add Welcome Item
            const welcomeLi = document.createElement('li');
            welcomeLi.dataset.index = -1;
            welcomeLi.classList.add('welcome-item');
            welcomeLi.setAttribute('role', 'button'); welcomeLi.setAttribute('tabindex', '0');
            const welcomeTitle = document.createElement('span');
            welcomeTitle.classList.add('week-title');
            welcomeTitle.textContent = "ðŸ‘‹ Welcome!";
            welcomeLi.appendChild(welcomeTitle);
            if (currentView === 'welcome') welcomeLi.classList.add('active');
            welcomeLi.addEventListener('click', () => navigateToView('welcome'));
            welcomeLi.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') navigateToView('welcome'); });
            weekList.appendChild(welcomeLi);

            // Add Week Items
            sketchingData.forEach((week, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;
                li.setAttribute('role', 'button'); li.setAttribute('tabindex', '0');
                const titleSpan = document.createElement('span'); titleSpan.classList.add('week-title'); titleSpan.textContent = `Wk ${week.WeekNum}: ${week.WeeklyPrompt}`;
                const statusSpan = document.createElement('span'); statusSpan.classList.add('week-status'); statusSpan.textContent = 'âœ”'; statusSpan.setAttribute('aria-hidden', 'true');
                li.appendChild(titleSpan); li.appendChild(statusSpan);

                if (currentView === 'detail' && index === currentWeekIndex) li.classList.add('active');
                if (completionStatus[week.WeekNum]) {
                     li.classList.add('completed');
                     li.setAttribute('aria-label', `Week ${week.WeekNum}: ${week.WeeklyPrompt} (Completed)`);
                 } else {
                     li.setAttribute('aria-label', `Week ${week.WeekNum}: ${week.WeeklyPrompt}`);
                 }

                li.addEventListener('click', () => navigateToView('detail', index));
                li.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') navigateToView('detail', index); });
                weekList.appendChild(li);
            });

             // Scroll active item into view (desktop only)
             if (window.innerWidth > 768) {
                 const activeItem = weekList.querySelector('.active');
                 if (activeItem) {
                     activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 }
             }
        }

        function renderContentArea() {
            contentArea.innerHTML = ''; // Clear previous content

            if (currentView === 'welcome') {
                renderWelcomeContent();
            } else if (currentView === 'detail') {
                renderWeekDetailContent();
            } else if (currentView === 'gallery') {
                renderGalleryContent();
            }
            contentArea.scrollTop = 0; // Scroll to top
        }

        function renderWelcomeContent() {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.classList.add('welcome-content');
            welcomeDiv.innerHTML = `
                <h1>Welcome to the Sketching Year!</h1>
                <p>This interactive guide follows the <strong>2025-26 Master Sketching Plan</strong>. Each week presents a new theme and prompt to inspire your creativity.</p>
                <p>Use the sidebar to navigate between the welcome message and the weekly lessons. For each week:</p>
                <ul>
                    <li>Read the guidance and encouragement.</li>
                    <li>Try the suggested techniques ("Try This").</li>
                    <li>Look at the example image (if provided).</li>
                    <li><strong>Upload a photo of your sketch</strong> using the "Choose Image" button. A small preview will be saved locally in your browser.</li>
                    <li>Once uploaded, you can mark the week as <strong>complete</strong>.</li>
                    <li>View the "Submissions Gallery" for a week to see your uploaded sketch (and simulated placeholders for others).</li>
                </ul>
                <p>Your progress and submission previews are saved in your browser's local storage, so they'll be here when you return on the same device and browser.</p>
                <p><strong>Ready to start?</strong> Click "Next" above or select Week 1 from the sidebar.</p>
             `;
             contentArea.appendChild(welcomeDiv);
        }

        function renderWeekDetailContent() {
             if (currentWeekIndex < 0 || currentWeekIndex >= totalWeeks) return; // Invalid index

             const week = sketchingData[currentWeekIndex];
             const weekNum = week.WeekNum;
             const submission = submissionStatus[weekNum];

             // Main Detail Div
             const detailDiv = document.createElement('div');
             detailDiv.id = 'week-detail'; // Keep ID for potential direct targeting if needed

             // Example Image Handling (Async load)
             let exampleImageHtml = '';
             const exampleImageContainerId = `example-image-container-${weekNum}`;
             if (week.ImageURL) {
                 let processedUrl = null;
                 if (week.ImageURL.includes('drive.google.com/file/d/')) { const m = week.ImageURL.match(/file\/d\/([^/]+)/); if (m) processedUrl = `https://lh3.googleusercontent.com/d/${m[1]}=w800`; }
                 else if (week.ImageURL.includes('photos.app.goo.gl/')) { processedUrl = week.ImageURL; } // Unreliable
                 else { processedUrl = week.ImageURL; }

                 if (processedUrl) {
                     exampleImageHtml = `<div id="${exampleImageContainerId}" class="image-placeholder">Loading example image...</div>`;
                     setTimeout(() => { /* ... (async image load logic from previous step) ... */
                         const container = document.getElementById(exampleImageContainerId); if (!container) return;
                         const img = new Image(); img.alt = `Example for ${week.WeeklyPrompt}`;
                         img.onload = () => { container.innerHTML = ''; container.className = 'image-loaded-container'; container.appendChild(img); };
                         img.onerror = () => { container.innerHTML = 'Example image failed to load.'; container.className = 'image-placeholder error'; };
                         img.src = processedUrl;
                     }, 0);
                 } else { exampleImageHtml = `<div class="image-placeholder">Invalid example image URL.</div>`; }
             } else { exampleImageHtml = `<div class="image-placeholder">No example image provided.</div>`; }

             detailDiv.innerHTML = `
                <h2>${week.WeeklyPrompt}</h2>
                <div class="week-meta"><strong>Week ${weekNum}</strong> | ${week.Date} | Theme: ${week.MonthlyTheme}</div>
                ${week.EncouragementMessage ? `<div class="encouragement-container">${formatTextContent(week.EncouragementMessage)}</div>` : ''}
                ${week.TryThis ? `<div class="trythis-container">${formatTextContent(week.TryThis)}</div>` : ''}
                ${exampleImageHtml}
             `;
             contentArea.appendChild(detailDiv);

             // Submission Area Div
             const submissionDiv = document.createElement('div');
             submissionDiv.classList.add('submission-area');
             submissionDiv.id = 'submission-section'; // For potential targeting
             submissionDiv.innerHTML = `
                <h4>Your Submission</h4>
                <label for="submission-upload" class="upload-label">Choose Image</label>
                <input type="file" id="submission-upload" name="submission_upload" accept="image/*">
                <span id="file-info">No file selected.</span>
                <img id="thumbnail-preview" src="" alt="Submission preview">
             `;
             contentArea.appendChild(submissionDiv);

             // Completion Toggle Div
             const completionDiv = document.createElement('div');
             completionDiv.classList.add('completion-toggle');
             completionDiv.innerHTML = `<button id="complete-button" disabled>Upload Submission to Complete</button>`;
             contentArea.appendChild(completionDiv);

             // Add event listeners to newly created elements
             const fileInput = submissionDiv.querySelector('#submission-upload');
             const completeBtn = completionDiv.querySelector('#complete-button');
             if (fileInput) fileInput.addEventListener('change', handleFileUpload);
             if (completeBtn) completeBtn.addEventListener('click', toggleCompletion);

             // Update submission display based on saved state
             const fileInfoSpan = submissionDiv.querySelector('#file-info');
             const thumbnailImg = submissionDiv.querySelector('#thumbnail-preview');
             if (submission) {
                 fileInfoSpan.textContent = `Submitted: ${submission.filename}`;
                 if (submission.thumbnail) {
                     thumbnailImg.src = submission.thumbnail;
                     thumbnailImg.style.display = 'block';
                 } else {
                     thumbnailImg.style.display = 'none';
                     fileInfoSpan.textContent += " (Preview not available)";
                 }
             } else {
                 fileInfoSpan.textContent = 'No file selected.';
                 thumbnailImg.style.display = 'none';
             }

             updateCompletionButtonState(); // Set initial state for the button
        }

        function renderGalleryContent() {
            const weekNum = selectedGalleryWeekNum;
            if (!weekNum) return; // Safety check

            const galleryDiv = document.createElement('div');
            galleryDiv.id = 'gallery-view';
            galleryDiv.innerHTML = `<h2>Submissions Gallery: Week ${weekNum}</h2><div class="gallery-grid"></div>`;
            const grid = galleryDiv.querySelector('.gallery-grid');

            let submissionsFound = false;

             // Display the user's submission
             const userSubmission = submissionStatus[weekNum];
             if (userSubmission && userSubmission.thumbnail) {
                 submissionsFound = true;
                 const itemDiv = document.createElement('div');
                 itemDiv.classList.add('gallery-item', 'user-submission');
                 itemDiv.innerHTML = `
                     <img src="${userSubmission.thumbnail}" alt="Your submission for Week ${weekNum}">
                     <div class="filename">You: ${userSubmission.filename}</div>
                 `;
                 grid.appendChild(itemDiv);
             } else if (userSubmission) { // Has filename but no thumbnail
                  submissionsFound = true;
                  const itemDiv = document.createElement('div');
                  itemDiv.classList.add('gallery-item', 'user-submission', 'no-preview');
                  itemDiv.innerHTML = `
                      <div class="placeholder">Preview N/A</div>
                      <div class="filename">You: ${userSubmission.filename}</div>
                  `;
                  grid.appendChild(itemDiv);
             }

             // --- Simulation: Add placeholder submissions ---
             const placeholderCount = 7; // Number of placeholders to show
             for (let i = 0; i < placeholderCount; i++) {
                 submissionsFound = true; // Consider placeholders as content
                 const itemDiv = document.createElement('div');
                 itemDiv.classList.add('gallery-item', 'placeholder');
                 itemDiv.innerHTML = `Placeholder ${i + 1}`;
                 grid.appendChild(itemDiv);
             }
             // --- End Simulation ---


            if (!submissionsFound) {
                grid.innerHTML = '<p class="no-submissions">No submissions (including yours) found for this week yet.</p>';
            }

            contentArea.appendChild(galleryDiv);
        }

         function updateHeader() {
             // Update Title
             if (currentView === 'welcome') {
                 currentWeekDisplay.textContent = "Welcome!";
             } else if (currentView === 'detail' && currentWeekIndex !== -1) {
                 const week = sketchingData[currentWeekIndex];
                 currentWeekDisplay.textContent = `Wk ${week.WeekNum}: ${week.WeeklyPrompt}`;
             } else if (currentView === 'gallery' && selectedGalleryWeekNum) {
                  currentWeekDisplay.textContent = `Gallery: Week ${selectedGalleryWeekNum}`;
             } else {
                 currentWeekDisplay.textContent = "Sketching Year"; // Fallback
             }

             // Update Buttons Visibility/State
             prevButton.style.display = (currentView !== 'gallery') ? 'inline-block' : 'none';
             nextButton.style.display = (currentView !== 'gallery') ? 'inline-block' : 'none';
             viewGalleryButton.style.display = (currentView === 'detail') ? 'inline-block' : 'none';
             backToDetailButton.style.display = (currentView === 'gallery') ? 'inline-block' : 'none';

             // Update Prev/Next Disabled State
             if (currentView === 'welcome') {
                 prevButton.disabled = true;
                 nextButton.disabled = false; // Can always go to Week 1
             } else if (currentView === 'detail') {
                 prevButton.disabled = currentWeekIndex <= 0; // Disable if on Week 1
                 nextButton.disabled = currentWeekIndex >= totalWeeks - 1; // Disable if on last week
                 // Disable gallery button if no submission exists for the current week (optional)
                 const currentWeekNum = sketchingData[currentWeekIndex]?.WeekNum;
                 viewGalleryButton.disabled = !(currentWeekNum && submissionStatus[currentWeekNum]);
             }
         }

        function updateProgress() {
             const completedCount = Object.values(completionStatus).filter(status => status === true).length;
             const progressPercent = totalWeeks > 0 ? (completedCount / totalWeeks) * 100 : 0;
             progressText.textContent = `Your Progress: ${completedCount} / ${totalWeeks}`;
             progressBar.style.width = `${progressPercent}%`;
         }

        // --- Event Handlers ---
        function handleFileUpload(event) {
             const file = event.target.files[0];
             if (currentView !== 'detail' || currentWeekIndex === -1) return; // Only handle in detail view

             const weekNum = sketchingData[currentWeekIndex].WeekNum;
             const fileInfoSpan = document.getElementById('file-info'); // Get fresh reference
             const thumbnailImg = document.getElementById('thumbnail-preview'); // Get fresh reference

             if (file && fileInfoSpan && thumbnailImg) {
                 fileInfoSpan.textContent = `Processing: ${file.name}`;
                 thumbnailImg.src = "";
                 thumbnailImg.style.display = 'none'; // Hide until ready

                 generateThumbnail(file, (thumbnailDataUrl) => {
                     const currentSubmission = {
                         filename: file.name,
                         thumbnail: thumbnailDataUrl
                     };
                     submissionStatus[weekNum] = currentSubmission;
                     saveData(SUBMISSION_STORAGE_KEY, submissionStatus);

                     // Update UI only if still on the same week
                     if (currentWeekIndex !== -1 && sketchingData[currentWeekIndex].WeekNum === weekNum) {
                        fileInfoSpan.textContent = `Submitted: ${currentSubmission.filename}`;
                         if (currentSubmission.thumbnail) {
                             thumbnailImg.src = currentSubmission.thumbnail;
                             thumbnailImg.style.display = 'block';
                         } else {
                             thumbnailImg.style.display = 'none';
                             fileInfoSpan.textContent += " (Preview not available)";
                         }
                         updateCompletionButtonState(); // Update button now submission exists
                     }
                 });
             }
         }
         function toggleCompletion() {
             if (currentView !== 'detail' || currentWeekIndex === -1) return;
             const completeBtn = document.getElementById('complete-button'); // Get fresh reference
             if (!completeBtn || completeBtn.disabled) return; // Don't toggle if disabled

             const week = sketchingData[currentWeekIndex];
             completionStatus[week.WeekNum] = !completionStatus[week.WeekNum];
             saveData(COMPLETION_STORAGE_KEY, completionStatus);
             updateCompletionButtonState(); // Update button text/state
             renderSidebarList(); // Update list style and progress bar
         }
         function navigateToView(viewType, index = currentWeekIndex) {
             // Set new state
             currentView = viewType;
             if (viewType === 'detail') {
                 currentWeekIndex = index;
                 selectedGalleryWeekNum = null; // Clear gallery selection
             } else if (viewType === 'gallery') {
                 // Ensure we are coming from a valid detail view
                 if (currentWeekIndex !== -1) {
                      selectedGalleryWeekNum = sketchingData[currentWeekIndex].WeekNum;
                 } else {
                      // Cannot go to gallery from welcome, maybe default to week 1? Or stay on welcome?
                      // Let's prevent gallery from welcome for simplicity
                      console.warn("Cannot view gallery from Welcome screen.");
                      currentView = 'welcome'; // Revert state
                      return;
                 }
             } else if (viewType === 'welcome') {
                  currentWeekIndex = -1; // Set index for welcome
                  selectedGalleryWeekNum = null;
             }
             updateUI(); // Re-render everything based on new state
         }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             loadState(); // Load both completion and submission states

             // Start on the Welcome screen
             navigateToView('welcome');

             // Add listeners for header buttons
             prevButton.addEventListener('click', () => {
                 if (currentView === 'detail') navigateToView('detail', currentWeekIndex - 1);
                 // Special case: Prev from Week 1 goes to Welcome
                 if (currentView === 'detail' && currentWeekIndex === 0) navigateToView('welcome');
             });
             nextButton.addEventListener('click', () => {
                 if (currentView === 'welcome') navigateToView('detail', 0); // Go to Week 1
                 else if (currentView === 'detail') navigateToView('detail', currentWeekIndex + 1);
             });
             viewGalleryButton.addEventListener('click', () => {
                 if (currentView === 'detail') navigateToView('gallery');
             });
             backToDetailButton.addEventListener('click', () => {
                  // Go back to the detail view of the week whose gallery was being viewed
                  const weekIndex = sketchingData.findIndex(w => w.WeekNum === selectedGalleryWeekNum);
                  if (weekIndex !== -1) {
                       navigateToView('detail', weekIndex);
                  } else {
                       navigateToView('welcome'); // Fallback if week not found
                  }
             });

             updateProgress(); // Initial progress update based on loaded status
        });

    </script>
</body>
</html>
